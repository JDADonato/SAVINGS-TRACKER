<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saver Pro | Momentum</title>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        zinc: { 850: '#27272a', 900: '#18181b', 950: '#09090b' },
                        primary: '#d8b4fe', secondary: '#818cf8', accent: '#2dd4bf', 
                        success: '#34d399', danger: '#fb7185', warning: '#fbbf24',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 
                        'slide-up': 'slideUp 0.3s ease-out', 
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'flash-green': 'flashGreen 1s ease-out'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        flashGreen: { '0%': { color: '#34d399' }, '100%': { color: 'white' } }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { background-color: #000000; color: #f4f4f5; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .btn-action { background: linear-gradient(to right, #d8b4fe, #818cf8); color: #000; font-weight: 600; transition: opacity 0.3s; }
        .btn-action:hover { opacity: 0.9; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Custom Switch */
        .switch-checkbox { display: none; }
        .switch-label { 
            position: relative; display: block; width: 40px; height: 22px; 
            background-color: #27272a; border-radius: 9999px; cursor: pointer; transition: 0.3s; 
        }
        .switch-label::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
            background-color: #fff; border-radius: 50%; transition: 0.3s;
        }
        .switch-checkbox:checked + .switch-label { background-color: #34d399; }
        .switch-checkbox:checked + .switch-label::after { transform: translateX(18px); }
        
        /* Disabled Input Style */
        .input-disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // üîß SETUP: URL PRE-FILLED
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbxNWva9ujwZpl4bIfDDs6X2PAaOYASbabuBDUQwYCf6domAvcUa9QWQxAx-1WE0ibrTzA/exec"; 

        // --- CONSTANTS ---
        const SEMESTER_START_DATE = new Date('2025-12-01');

        // --- COMPONENTS ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
            return (
                <div className={`fixed bottom-8 left-1/2 transform -translate-x-1/2 z-[60] animate-slide-up flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl glass border ${type === 'success' ? 'border-success/30 text-success' : type === 'info' ? 'border-secondary/30 text-secondary' : 'border-danger/30 text-danger'}`}>
                    <span className="text-lg">{type === 'success' ? '‚úì' : type === 'info' ? '‚Ñπ' : '‚ö†'}</span>
                    <span className="font-medium text-sm text-zinc-100 whitespace-nowrap">{message}</span>
                </div>
            );
        };

        const Modal = ({ isOpen, title, children, onConfirm, onCancel, confirmText = "Confirm", isDanger = false, showCancel = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-sm" onClick={onCancel}></div>
                    <div className="glass relative z-50 w-full max-w-sm p-6 rounded-3xl shadow-2xl border border-zinc-800 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-xl font-bold text-white mb-4 text-center tracking-tight">{title}</h3>
                        <div className="text-zinc-400 text-sm mb-8 leading-relaxed text-center">{children}</div>
                        <div className="flex gap-3">
                            {showCancel && <button onClick={onCancel} className="flex-1 py-3 rounded-2xl text-sm font-medium text-zinc-400 bg-zinc-900 border border-zinc-800 hover:bg-zinc-800 hover:text-white transition-colors">Cancel</button>}
                            <button onClick={onConfirm} className={`flex-1 py-3 rounded-2xl text-sm font-bold shadow-lg transition-transform active:scale-95 ${isDanger ? 'bg-zinc-900 border border-danger/50 text-danger hover:bg-danger/10' : 'bg-white text-black hover:bg-zinc-200'}`}>{confirmText}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NumberInput = ({ value, onChange, placeholder, disabled }) => {
            const update = (val) => { const num = parseFloat(val) || 0; if (num < 0) return; onChange(num); };
            return (
                <div className={`relative flex items-center w-full border rounded-xl transition-colors ${disabled ? 'bg-zinc-900 border-zinc-800 opacity-50 cursor-not-allowed' : 'bg-black/40 border-zinc-800 focus-within:border-zinc-600'}`}>
                    <button disabled={disabled} onClick={() => update(parseFloat(value||0) - 5)} className="px-4 text-zinc-500 hover:text-white font-medium border-r border-zinc-800 py-3 disabled:cursor-not-allowed transition-colors">‚Äì</button>
                    <input disabled={disabled} type="number" value={value} placeholder={placeholder} onChange={(e) => update(e.target.value)} className="w-full bg-transparent text-center text-sm py-2 text-white outline-none appearance-none disabled:cursor-not-allowed font-mono"/>
                    <button disabled={disabled} onClick={() => update(parseFloat(value||0) + 5)} className="px-4 text-zinc-500 hover:text-white font-medium border-l border-zinc-800 py-3 disabled:cursor-not-allowed transition-colors">+</button>
                </div>
            );
        };

        // --- CHART COMPONENT ---
        const SavingsChart = ({ history, currentSavings, weeksPassed }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if(!canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d');
                const labels = Array.from({length: weeksPassed + 1}, (_, i) => `W${i}`);
                
                let runningTotal = 0; 
                const dataPoints = [0]; 
                history.slice().sort((a,b) => a.week - b.week).forEach(h => {
                    runningTotal += (h.savedExtra || 0); 
                    dataPoints.push(runningTotal);
                });
                
                if (dataPoints.length <= weeksPassed) dataPoints.push(currentSavings);

                let gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(52, 211, 153, 0.2)'); gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Wallet Savings', data: dataPoints, borderColor: '#34d399', borderWidth: 2, backgroundColor: gradient, tension: 0.4, pointRadius: 0, pointHoverRadius: 4, fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false }, tooltip: { backgroundColor: '#18181b', titleColor: '#fff', bodyColor: '#a1a1aa', borderColor: '#27272a', borderWidth: 1, padding: 10 } },
                        scales: { y: { grid: { color: '#27272a' }, ticks: { color: '#52525b', font: {size: 10} }, border: {display: false} }, x: { grid: { display: false }, ticks: { color: '#52525b', font: {size: 10} }, border: {display: false} } }
                    }
                });
                return () => chart.destroy();
            }, [history, currentSavings, weeksPassed]);
            return <canvas ref={canvasRef} height="200"></canvas>;
        };

        // --- MAIN APP ---
        const App = () => {
            const [config, setConfig] = useState(() => {
                const savedConfig = localStorage.getItem('savings_config');
                const defaults = { dailyLimit: 335, weeklyAllowance: 670, semesterWeeks: 33, baseGoal: 42081, commuteCost: 155, startDate: '2025-12-01', enableChart: true };
                return savedConfig ? { ...defaults, ...JSON.parse(savedConfig) } : defaults;
            });

            const [isChartCollapsed, setIsChartCollapsed] = useState(() => localStorage.getItem('savings_chart_collapsed') === 'true');
            const [isLoading, setIsLoading] = useState(true);
            const [viewWeek, setViewWeek] = useState(1);
            
            const [data, setData] = useState({
                currentWeek: 1, 
                totalUnplanned: 0, 
                previousProjected: config.baseGoal, // Track the "Last Week's" Goal
                history: [], 
                unplannedHistory: [],
                days: [ { id: 1, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false }, { id: 2, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false } ]
            });

            const [spendModalOpen, setSpendModalOpen] = useState(false);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [resetModalOpen, setResetModalOpen] = useState(null); 
            const [spendAmount, setSpendAmount] = useState('');
            const [spendReason, setSpendReason] = useState('');
            const [tempConfig, setTempConfig] = useState(config);
            const [toast, setToast] = useState(null);
            const [modal, setModal] = useState(null);
            
            const prevSavingsRef = useRef(0);

            // --- LOAD ---
            useEffect(() => {
                const load = async () => {
                    const localData = localStorage.getItem('savings_tracker_pro');
                    if (localData) { 
                        const parsed = JSON.parse(localData); 
                        // Migration: Ensure previousProjected exists
                        if(parsed.previousProjected === undefined) parsed.previousProjected = config.baseGoal;
                        setData(parsed); 
                        setViewWeek(parsed.currentWeek); 
                    }
                    try { 
                        const response = await fetch(API_URL); 
                        const cloudData = await response.json(); 
                        if (cloudData) {
                            const migratedData = { 
                                ...cloudData, 
                                days: cloudData.days.map(d => ({...d, isSkipped: d.isSkipped || false})),
                                previousProjected: cloudData.previousProjected !== undefined ? cloudData.previousProjected : config.baseGoal 
                            };
                            setData(prev => ({ ...prev, ...migratedData })); 
                        }
                    } catch (e) { console.log("Offline"); }
                    setIsLoading(false);
                };
                load();
            }, []);

            // --- SAVE ---
            const isFirstRender = useRef(true);
            useEffect(() => {
                if (isFirstRender.current) { isFirstRender.current = false; return; }
                localStorage.setItem('savings_tracker_pro', JSON.stringify(data));
                localStorage.setItem('savings_config', JSON.stringify(config));
                localStorage.setItem('savings_chart_collapsed', isChartCollapsed);
                const timeoutId = setTimeout(async () => {
                    try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); } catch (e) {}
                }, 1000);
                return () => clearTimeout(timeoutId);
            }, [data, config, isChartCollapsed]);

            // --- STATS ENGINE ---
            const stats = useMemo(() => {
                const historySavings = data.history.reduce((acc, h) => acc + (h.savedExtra || 0), 0);

                let activeWeekSavings = 0;
                data.days.forEach(d => {
                    if (d.isDone && !d.carryOver) {
                        const spent = d.isSkipped ? 0 : ((parseFloat(d.food)||0) + (parseFloat(d.commute)||0));
                        activeWeekSavings += Math.max(0, config.dailyLimit - spent);
                    }
                });

                const currentSavings = historySavings + activeWeekSavings - data.totalUnplanned;
                const projectedTotal = config.baseGoal + currentSavings;
                
                // Trend Logic
                const trendDiff = projectedTotal - (data.previousProjected || config.baseGoal);

                // Active Week Logic
                let daysToCalc = data.days;
                if (viewWeek < data.currentWeek) {
                    const pastWeek = data.history.find(h => h.week === viewWeek);
                    if (pastWeek && pastWeek.days) daysToCalc = pastWeek.days;
                }

                let spentThisWeek = 0;
                let lockedWeeklySavings = 0;
                daysToCalc.forEach(d => {
                    const dailyTotal = d.isSkipped ? 0 : ((parseFloat(d.food)||0) + (parseFloat(d.commute)||0));
                    if(d.isDone) {
                        spentThisWeek += dailyTotal;
                        if(!d.carryOver) lockedWeeklySavings += Math.max(0, config.dailyLimit - dailyTotal);
                    } else if(dailyTotal > 0) spentThisWeek += dailyTotal;
                });
                
                const remaining = config.weeklyAllowance - spentThisWeek - lockedWeeklySavings;

                return { spentThisWeek, remaining, currentSavings, projectedTotal, trendDiff };
            }, [data, viewWeek, config]);

            // --- FEEDBACK ---
            useEffect(() => {
                if (viewWeek < data.currentWeek) {
                    const diff = stats.currentSavings - prevSavingsRef.current;
                    if (diff !== 0 && Math.abs(diff) < 1000) { 
                        const sign = diff > 0 ? '+' : '';
                        setToast({ message: `Savings adjusted: ${sign}‚Ç±${Math.abs(diff)}`, type: 'info' });
                    }
                }
                prevSavingsRef.current = stats.currentSavings;
            }, [stats.currentSavings, viewWeek, data.currentWeek]);

            // --- DATE LOGIC ---
            const weekDates = useMemo(() => {
                const weekStart = new Date(SEMESTER_START_DATE);
                weekStart.setDate(weekStart.getDate() + (viewWeek - 1) * 7);
                const wed = new Date(weekStart); wed.setDate(wed.getDate() + 2);
                const thu = new Date(weekStart); thu.setDate(thu.getDate() + 3);
                return {
                    wed: `Wed, ${wed.toLocaleDateString('en-US', {month:'short', day:'numeric'})}`,
                    thu: `Thu, ${thu.toLocaleDateString('en-US', {month:'short', day:'numeric'})}`
                };
            }, [viewWeek]);

            // --- ACTIONS ---
            const updateDay = (id, updates) => {
                if (viewWeek === data.currentWeek) {
                    setData(prev => ({ ...prev, days: prev.days.map(d => d.id === id ? { ...d, ...updates } : d) }));
                } else {
                    setData(prev => ({
                        ...prev,
                        history: prev.history.map(h => {
                            if (h.week === viewWeek) {
                                const newDays = h.days.map(d => d.id === id ? { ...d, ...updates } : d);
                                let newSavedExtra = 0;
                                newDays.forEach(d => {
                                    if (d.isDone && !d.carryOver) {
                                        const spent = d.isSkipped ? 0 : ((parseFloat(d.food)||0) + (parseFloat(d.commute)||0));
                                        newSavedExtra += Math.max(0, config.dailyLimit - spent);
                                    }
                                });
                                return { ...h, days: newDays, savedExtra: newSavedExtra };
                            }
                            return h;
                        })
                    }));
                }
            };

            const toggleSkipped = (id) => {
                let day;
                if(viewWeek === data.currentWeek) day = data.days.find(d => d.id === id);
                else { const hist = data.history.find(h => h.week === viewWeek); if(hist) day = hist.days.find(d => d.id === id); }
                
                if (!day) return;
                if (day.isSkipped) updateDay(id, { isSkipped: false, isDone: false, food: '', commute: config.commuteCost });
                else updateDay(id, { isSkipped: true, isDone: true, food: 0, commute: 0, carryOver: false }); 
            };

            const finishWeek = () => {
                let extraSavings = 0;
                data.days.forEach(d => {
                    if (d.isDone && !d.carryOver) {
                        const spent = d.isSkipped ? 0 : ((parseFloat(d.food)||0) + (parseFloat(d.commute)||0));
                        extraSavings += Math.max(0, config.dailyLimit - spent);
                    }
                });

                const newHistoryItem = { week: data.currentWeek, savedExtra: extraSavings, date: new Date().toLocaleDateString(), days: data.days };

                setModal({
                    title: `Finish Week ${data.currentWeek}?`,
                    children: <div className="text-center"><p className="text-zinc-500 mb-1">Total Spent</p><p className="text-2xl font-bold text-white mb-4">‚Ç±{stats.spentThisWeek}</p><p className="text-zinc-500 mb-1">Added to Wallet</p><p className="text-2xl font-bold text-success">‚Ç±{Math.floor(extraSavings)}</p></div>,
                    onConfirm: () => {
                        setData(prev => ({ 
                            ...prev, 
                            currentWeek: prev.currentWeek + 1, 
                            // IMPORTANT: Snapshot current projected as the new "Previous" for next week's comparison
                            previousProjected: stats.projectedTotal, 
                            history: [...prev.history, newHistoryItem], 
                            days: prev.days.map(d => ({ ...d, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false })) 
                        }));
                        setViewWeek(prev => prev + 1); setModal(null); setToast({ message: "Week saved", type: "success" });
                    },
                    onCancel: () => setModal(null)
                });
            };

            const handleResetAll = async () => {
                const emptyData = {
                    currentWeek: 1, totalUnplanned: 0, previousProjected: config.baseGoal, history: [], unplannedHistory: [],
                    days: [{ id: 1, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false }, { id: 2, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false }]
                };
                setToast({ message: "Wiping Cloud Database...", type: "warning" });
                try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(emptyData) }); } catch (e) { console.error(e); }
                localStorage.removeItem('savings_tracker_pro');
                setTimeout(() => window.location.reload(), 1500);
            };

            const saveSettings = () => { setConfig(tempConfig); setSettingsOpen(false); setToast({ message: "Preferences updated", type: "success" }); };

            // Budget Calc
            let daysToRender = viewWeek === data.currentWeek ? data.days : (data.history.find(h => h.week === viewWeek)?.days || []);
            if (viewWeek < data.currentWeek && daysToRender.length === 0) daysToRender = [{id:1},{id:2}]; 
            
            let runningCarryOver = 0;
            const daysWithBudgets = daysToRender.map(day => {
                const budgetForToday = config.dailyLimit + runningCarryOver;
                const spentToday = day.isSkipped ? 0 : ((parseFloat(day.food)||0) + (parseFloat(day.commute)||0));
                if (day.isDone && day.carryOver) runningCarryOver = Math.max(0, budgetForToday - spentToday); else runningCarryOver = 0;
                return { ...day, budgetAvailable: budgetForToday };
            });

            if (isLoading) return <div className="min-h-screen flex items-center justify-center text-zinc-600 animate-pulse tracking-widest text-xs uppercase">Loading...</div>;

            return (
                <div className="w-full max-w-md space-y-8 pb-24 relative">
                    
                    {/* Header */}
                    <div className="flex justify-between items-center pt-2">
                         <div className="flex items-center gap-4">
                            <img src="logo.png" alt="Logo" className="w-11 h-11 rounded-2xl shadow-2xl border border-white/5" />
                            <div><h1 className="text-2xl font-bold text-white tracking-tight">Saver<span className="text-zinc-500">Pro</span></h1><p className="text-[10px] text-zinc-500 uppercase tracking-widest">Semester Goal</p></div>
                         </div>
                         <button onClick={() => { setTempConfig(config); setSettingsOpen(true); }} className="w-10 h-10 flex items-center justify-center rounded-full bg-zinc-900 border border-zinc-800 text-zinc-400 hover:text-white transition-colors">‚öôÔ∏è</button>
                    </div>

                    {/* Chart */}
                    {config.enableChart && (
                        <div className="glass rounded-3xl overflow-hidden transition-all duration-300">
                            <div onClick={() => setIsChartCollapsed(!isChartCollapsed)} className="p-5 flex justify-between items-center cursor-pointer hover:bg-white/5 active:bg-white/10 transition-colors">
                                <span className="text-xs font-bold text-zinc-500 uppercase tracking-widest">Analytics</span>
                                <span className={`transform transition-transform duration-300 text-zinc-600 ${isChartCollapsed ? '-rotate-90' : 'rotate-0'}`}>‚ñº</span>
                            </div>
                            {!isChartCollapsed && (<div className="px-4 pb-4"><SavingsChart history={data.history} currentSavings={stats.currentSavings} weeksPassed={stats.currentWeek - 1} /></div>)}
                        </div>
                    )}

                    {/* Stats */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass p-5 rounded-3xl relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><span className="text-4xl">üí∞</span></div>
                            <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest mb-1">Wallet Savings</p>
                            <p className={`text-2xl font-bold text-white tracking-tight ${viewWeek < data.currentWeek ? 'animate-flash-green' : ''}`}>‚Ç±{Math.floor(stats.currentSavings).toLocaleString()}</p>
                        </div>
                        <div className="glass p-5 rounded-3xl relative overflow-hidden group flex flex-col justify-center">
                            <div className="absolute top-0 right-0 p-4 opacity-10"><span className="text-4xl">üèÅ</span></div>
                            <p className="text-zinc-500 text-[10px] uppercase font-bold tracking-widest mb-1">End Goal</p>
                            <div className="flex items-baseline gap-2">
                                <p className="text-2xl font-bold text-zinc-300 tracking-tight">‚Ç±{Math.floor(stats.projectedTotal).toLocaleString()}</p>
                                {/* Trend Indicator */}
                                {Math.abs(stats.trendDiff) > 0 && (
                                    <span className={`text-[10px] font-bold ${stats.trendDiff > 0 ? 'text-success' : 'text-danger'}`}>
                                        {stats.trendDiff > 0 ? '‚ñ≤' : '‚ñº'} ‚Ç±{Math.abs(Math.floor(stats.trendDiff))}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Tracker */}
                    <div className="glass rounded-3xl p-1 relative">
                         <div className="flex justify-between items-center p-4 border-b border-zinc-800/50">
                            <button onClick={() => setViewWeek(prev => Math.max(1, prev - 1))} className={`w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 text-zinc-400 ${viewWeek === 1 ? 'opacity-20' : ''}`} disabled={viewWeek === 1}>‚Üê</button>
                            <div className="text-center"><h2 className="font-bold text-lg text-white tracking-tight">Week {viewWeek}</h2>{viewWeek === data.currentWeek ? <p className="text-xs text-zinc-500 mt-0.5">Pool: <span className="text-white font-mono">‚Ç±{stats.remaining}</span></p> : <span className="text-[10px] bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded border border-zinc-700">HISTORY VIEW</span>}</div>
                            <button onClick={() => setViewWeek(prev => Math.min(data.currentWeek, prev + 1))} className={`w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 text-zinc-400 ${viewWeek === data.currentWeek ? 'opacity-20' : ''}`} disabled={viewWeek === data.currentWeek}>‚Üí</button>
                         </div>

                         <div className="p-4 space-y-4">
                            {daysWithBudgets.map((day, idx) => {
                                const dateLabel = idx === 0 ? weekDates.wed : weekDates.thu;
                                return (
                                    <div key={day.id || idx} className={`p-5 rounded-2xl border transition-all duration-300 ${day.isSkipped ? 'border-zinc-800 bg-zinc-900 opacity-60' : day.isDone ? 'border-success/20 bg-success/5' : 'border-zinc-800 bg-black/20'}`}>
                                        <div className="flex justify-between items-center mb-4">
                                            <div>
                                                <span className="text-sm font-bold text-zinc-200 block tracking-tight">{dateLabel}</span>
                                                {!day.isSkipped && <span className="text-[10px] text-zinc-500 font-mono mt-1 block">Budget: ‚Ç±{day.budgetAvailable}</span>}
                                                {day.isSkipped && <span className="text-[10px] text-zinc-500 font-bold bg-zinc-800 px-2 py-0.5 rounded mt-1 inline-block">NO CLASS</span>}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => toggleSkipped(day.id)} className={`text-[10px] px-3 py-1.5 font-bold rounded-full transition-all ${day.isSkipped ? 'bg-zinc-700 text-white' : 'bg-transparent border border-zinc-700 text-zinc-500 hover:border-zinc-500'}`}>{day.isSkipped ? 'Undo' : '‚õî'}</button>
                                                <button onClick={() => updateDay(day.id, { isDone: !day.isDone })} className={`text-[10px] px-4 py-1.5 font-bold rounded-full transition-all tracking-wider ${day.isDone ? 'bg-success text-black' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'}`}>{day.isDone ? 'DONE' : 'MARK'}</button>
                                            </div>
                                        </div>
                                        
                                        <div className={`transition-opacity duration-300 ${day.isSkipped ? 'input-disabled' : 'opacity-100'}`}>
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div><p className="text-[10px] text-zinc-500 mb-2 uppercase tracking-wider text-center">Commute</p><NumberInput value={day.commute} onChange={(val) => updateDay(day.id, {commute: val})} /></div>
                                                <div><p className="text-[10px] text-zinc-500 mb-2 uppercase tracking-wider text-center">Food</p><NumberInput value={day.food} placeholder="0" onChange={(val) => updateDay(day.id, {food: val})} /></div>
                                            </div>
                                        </div>

                                        <div className="pt-3 border-t border-zinc-800/50 flex justify-between items-center">
                                            <span className={`text-[10px] tracking-wide transition-colors ${day.carryOver ? 'text-zinc-300' : 'text-zinc-500'}`}>{day.carryOver ? "Carry surplus to next day" : "Lock surplus as savings"}</span>
                                            <div><input type="checkbox" id={`switch-${day.id}`} className="switch-checkbox" checked={day.carryOver} onChange={() => updateDay(day.id, {carryOver: !day.carryOver})} /><label htmlFor={`switch-${day.id}`} className="switch-label"></label></div>
                                        </div>
                                    </div>
                                );
                            })}
                         </div>
                         {viewWeek === data.currentWeek && (
                            <div className="p-4 pt-0"><button onClick={finishWeek} disabled={!data.days.every(d => d.isDone)} className="w-full py-4 rounded-2xl font-bold text-black btn-action shadow-lg disabled:opacity-50 disabled:grayscale transition-all">Finish Week</button></div>
                         )}
                    </div>

                    <div className="text-center pb-8">
                        <button onClick={() => setSpendModalOpen(true)} className="text-xs text-danger border border-danger/20 px-5 py-2.5 rounded-full hover:bg-danger/10 transition-colors inline-flex items-center gap-2">Record Unplanned Spend</button>
                    </div>

                    {/* SETTINGS MODAL */}
                    <Modal isOpen={settingsOpen} title="Settings" confirmText="Save" onConfirm={saveSettings} onCancel={() => setSettingsOpen(false)}>
                        <div className="space-y-4">
                            <div><label className="text-xs text-zinc-500 block mb-1">Daily Limit (‚Ç±)</label><input type="number" value={tempConfig.dailyLimit} onChange={(e) => setTempConfig({...tempConfig, dailyLimit: parseInt(e.target.value)})} className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-white focus:border-zinc-600 outline-none" /></div>
                            <div><label className="text-xs text-zinc-500 block mb-1">Weekly Allowance (‚Ç±)</label><input type="number" value={tempConfig.weeklyAllowance} onChange={(e) => setTempConfig({...tempConfig, weeklyAllowance: parseInt(e.target.value)})} className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-white focus:border-zinc-600 outline-none" /></div>
                            <div className="flex items-center justify-between pt-4 border-t border-zinc-800">
                                <label className="text-sm text-zinc-300">Show Chart</label>
                                <div><input type="checkbox" id="chart-switch" className="switch-checkbox" checked={tempConfig.enableChart} onChange={() => setTempConfig({...tempConfig, enableChart: !tempConfig.enableChart})} /><label htmlFor="chart-switch" className="switch-label"></label></div>
                            </div>
                            <div className="pt-6 mt-6 border-t border-zinc-800">
                                <p className="text-[10px] text-zinc-600 uppercase tracking-widest mb-3 font-bold">Data Management</p>
                                <div className="space-y-3">
                                    <button onClick={() => setResetModalOpen('week')} className="w-full py-3 rounded-xl border border-zinc-700 text-zinc-300 text-xs font-medium hover:bg-zinc-800">Reset Current Week Inputs</button>
                                    <button onClick={() => setResetModalOpen('all')} className="w-full py-3 rounded-xl border border-danger/30 text-danger text-xs font-medium hover:bg-danger/10">Start from Scratch (Reset All)</button>
                                </div>
                            </div>
                        </div>
                    </Modal>

                    {/* SPEND MODAL */}
                    <Modal isOpen={spendModalOpen} title="Unplanned Spending" confirmText="Record" isDanger={true} onConfirm={() => {
                        const amount = parseFloat(spendAmount);
                        if(amount > 0) { setData(prev => ({ ...prev, totalUnplanned: prev.totalUnplanned + amount, unplannedHistory: [{ id: Date.now(), week: prev.currentWeek, amount, reason: spendReason }, ...prev.unplannedHistory] })); setToast({ message: "Recorded", type: "success" }); setSpendModalOpen(false); setSpendAmount(''); setSpendReason(''); }
                    }} onCancel={() => setSpendModalOpen(false)}>
                        <div className="space-y-4">
                            <input type="number" value={spendAmount} onChange={(e) => setSpendAmount(e.target.value)} className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-white focus:border-danger outline-none" placeholder="Amount (‚Ç±)" />
                            <input type="text" value={spendReason} onChange={(e) => setSpendReason(e.target.value)} className="w-full bg-zinc-900 border border-zinc-800 rounded-xl p-3 text-white focus:border-danger outline-none" placeholder="Reason (e.g., Coffee, Gift)" />
                        </div>
                    </Modal>

                    {/* RESET MODALS */}
                    {resetModalOpen === 'week' && ( <Modal isOpen={true} title="Reset Week?" confirmText="Yes, Reset" onConfirm={() => { setData(prev => ({ ...prev, days: prev.days.map(d => ({ ...d, food: '', commute: config.commuteCost, isDone: false, carryOver: false, isSkipped: false })) })); setResetModalOpen(null); setSettingsOpen(false); setToast({ message: "Week reset", type: "success" }); }} onCancel={() => setResetModalOpen(null)}>Are you sure? This clears inputs for the current week.</Modal> )}
                    {resetModalOpen === 'all' && ( <Modal isOpen={true} title="Delete Everything?" confirmText="Yes, Delete All" isDanger={true} onConfirm={handleResetAll} onCancel={() => setResetModalOpen(null)}>This will wipe all data, history, and cloud settings permanently.</Modal> )}

                    <Modal isOpen={!!modal} title={modal?.title} onConfirm={modal?.onConfirm} onCancel={modal?.onCancel}>{modal?.children}</Modal>
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
